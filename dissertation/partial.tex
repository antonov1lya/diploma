\subsection{Частный коэффициент корреляции Пирсона в трехмерном распределении Бернулли}\label{partial_section}
Согласно \cite{Anderson2003} в трехмерном нормальном распределении случайные величины 
$X$ и $Y$ условно независимы при условии $Z$ тогда и только тогда, когда частный коэффициент корреляции Пирсона
$\rho^{XY \cdot Z}$ принимает значение $0$.
В данном разделе проверим сохраняется ли это свойство в трехмерном распределении Бернулли.
Пусть $(X,Y,Z)^T$ -- случайный вектор с трехмерным распределение Бернулли,
$\Sigma$ -- ковариационная матрица:
$$\Sigma =
    \begin{pmatrix}
        \sigma_{XX} & \sigma_{XY} & \sigma_{XZ} \\
        \sigma_{YX} & \sigma_{YY} & \sigma_{YZ} \\
        \sigma_{ZX} & \sigma_{ZY} & \sigma_{ZZ}
    \end{pmatrix}
$$
Остатками от $X$ и $Y$ при регрессии на $Z$ называются случайные величины:
$$
X^{\prime}=(X-EX)-\dfrac{\sigma_{XZ}}{\sigma_{ZZ}}(Z-EZ)
$$
$$
Y^{\prime}=(Y-EY)-\dfrac{\sigma_{YZ}}{\sigma_{ZZ}}(Z-EZ)
$$
Согласно работе \cite{Cramér1946} частным коэффициентом корреляции Пирсона называется:
$$
\rho^{XY \cdot Z}=\dfrac{E(X^{\prime} Y^{\prime})}{\sqrt{E(X^{\prime})^2 E(Y^{\prime})^2}}
$$
Для частного коэффициента корреляции Пирсона установим явную формулу.
\begin{lemma}\label{partial_formula1}
    $$
    \rho^{XY \cdot Z}=\dfrac{\sigma_{XY} \sigma_{ZZ} - \sigma_{XZ} \sigma_{YZ}}{\sqrt{\sigma_{XX}\sigma_{ZZ}-
    \sigma_{XZ}^2}\sqrt{\sigma_{YY}\sigma_{ZZ}-\sigma_{YZ}^2}}
    $$
\end{lemma}
\begin{proof}
    $$E(X^\prime Y^\prime)=E[((X-EX)-\dfrac{\sigma_{XZ}}{\sigma_{ZZ}}(Z-EZ))((Y-EY)-\dfrac{\sigma_{YZ}}{\sigma_{ZZ}}(Z-EZ))]=$$
    $$=\sigma_{XY}-\dfrac{\sigma_{YZ}}{\sigma_{ZZ}}\sigma_{XZ}-\dfrac{\sigma_{XZ}}{\sigma_{ZZ}}\sigma_{YZ}+
    \dfrac{\sigma_{XZ}\sigma_{YZ}}{\sigma_{ZZ}\sigma_{ZZ}}\sigma_{ZZ}=\sigma_{XY}-\dfrac{\sigma_{XZ} \sigma_{YZ}}{ \sigma_{ZZ}}=
    $$
    $$
    =\dfrac{\sigma_{XY}\sigma_{ZZ}-\sigma_{XZ}\sigma_{YZ}}{\sigma_{ZZ}}$$

    $$
    \rho^{XY \cdot Z}=\dfrac{\dfrac{\sigma_{XY}\sigma_{ZZ}-\sigma_{XZ}\sigma_{YZ}}{\sigma_{ZZ}}}
    {\sqrt{
        \dfrac{\sigma_{XX}\sigma_{ZZ}-\sigma_{XZ}\sigma_{XZ}}{\sigma_{ZZ}}
    }\sqrt{
        \dfrac{\sigma_{YY}\sigma_{ZZ}-\sigma_{YZ}\sigma_{YZ}}{\sigma_{ZZ}}
    }}=
    $$
    $$
    =\dfrac{\sigma_{XY} \sigma_{ZZ} - \sigma_{XZ} \sigma_{YZ}}{\sqrt{\sigma_{XX}\sigma_{ZZ}-
    \sigma_{XZ}^2}\sqrt{\sigma_{YY}\sigma_{ZZ}-\sigma_{YZ}^2}}
    $$
\end{proof}
Для дальнейших рассуждений удобно принять следующие обозначения: 
$$p_{x**}=P(X=x), \; p_{*y*}=P(Y=y), \; p_{**z}=P(Z=z)$$ 
$$  p_{xy*}=P(X=x, Y=y),\; p_{x*z}=P(X=x, Z=z), \; p_{*yz}=P(Y=y, Z=z)$$
Путем алгебраических преобразований, установим соотношение для числителя частного коэффициента корреляции Пирсона в трехмерном распределении Бернулли.
\begin{lemma}\label{partial_cov}
    $$\sigma_{XY} \sigma_{ZZ} - \sigma_{XZ} \sigma_{YZ} = p_{**0}(p_{001}p_{111}-p_{011}p_{101}) + p_{**1} (p_{000}p_{110}-p_{010}p_{100})$$
\end{lemma}
\begin{proof}
    Легко проверить, что $\sigma_{XX}= p_{1**}(1-p_{1**})$. Найдем соотношение для $\sigma_{XY}$. Воспользуемся формулой $\sigma_{XY}=E(X Y)-E(X)E(Y)$.
    $$E(X Y) = 1 \cdot p_{11*} + 0 \cdot (p_{00*} + p_{01*} + p_{10*})=p_{11*}$$
    $$EX = 1 \cdot p_{1**} + 0 \cdot p_{0**}=p_{1**}$$
    $$ EY = 1 \cdot p_{*1*} + 0 \cdot p_{*0*} = p_{*1*}$$
    Таким образом, $\sigma_{XY}=p_{11*}-p_{1**}p_{*1*}$. Аналогично, $\sigma_{XZ}=p_{1*1}-p_{1**}p_{**1}$ и $\sigma_{YZ}=p_{*11}-p_{*1*}p_{**1}$.
    Непосредственно преобразуем выражение:
    $$ \sigma_{XY} \sigma_{ZZ} - \sigma_{XZ} \sigma_{YZ} = $$
    $$
        = (p_{11*}-p_{1**}p_{*1*}) p_{**1}(1-p_{**1})
        -(p_{1*1}-p_{1**}p_{**1})(p_{*11}-p_{*1*}p_{**1})=
    $$
    $$
        = p_{11*}p_{**1} - p_{11*}p_{**1}p_{**1} - p_{1**}p_{*1*}p_{**1} + p_{1**}p_{*1*}p_{**1}p_{**1}-
    $$
    $$
        -p_{1*1}p_{*11}+p_{1*1}p_{*1*}p_{**1}+p_{1**}p_{**1}p_{*11} -p_{1**}p_{**1}p_{*1*}p_{**1}=
    $$
    $$
        =p_{111}p_{**1}+p_{110}p_{**1} - p_{11*}p_{**1}p_{**1} - p_{1**}p_{*1*}p_{**1} -
    $$ $$
        -p_{1*1}p_{*11}+p_{1*1}p_{*1*}p_{**1}+p_{1**}p_{**1}p_{*11}=
    $$
    \begin{equation}\label{some_step}
        =(p_{111}p_{**1}-p_{1*1}p_{*11})+p_{**1}(p_{110}-p_{11*}p_{**1} - p_{1**}p_{*1*} + p_{1*1}p_{*1*} + p_{1**}p_{*11})
    \end{equation}

    Заметим, что:
    \begin{enumerate}
        \item $$
        p_{110}-p_{11*}p_{**1}=p_{110}-p_{110}p_{**1}-p_{111}p_{**1}=
        p_{110}(1-p_{**1})-p_{111}p_{**1}=
    $$
    $$   
        =p_{110}p_{**0}-p_{111}p_{**1}
    $$
    \item
    $$
        -p_{1**}p_{*1*} + p_{1*1}p_{*1*} + p_{1**}p_{*11}=
    $$
    $$
        =-(p_{1*0}+p_{1*1})(p_{*10}+p_{*11})+p_{1*1}(p_{*10}+p_{*11}) + (p_{1*0}+p_{1*1})p_{*11}=
    $$
    $$
        =-p_{1*0}p_{*10}-p_{1*0}p_{*11}-p_{1*1}p_{*10}-p_{1*1}p_{*11}+$$
    $$
        +p_{1*1}p_{*10}+p_{1*1}p_{*11}+p_{1*0}p_{*11}+p_{1*1}p_{*11}=
    $$
    $$
        =-p_{1*0}p_{*10}+p_{1*1}p_{*11}
    $$
    \end{enumerate}
    Учитывая вышеприведенные соотношения, запишем выражение \eqref{some_step}.
    $$
    (p_{111}p_{**1}-p_{1*1}p_{*11})+p_{**1}((p_{110}p_{**0}-p_{1*0}p_{*10})-(p_{111}p_{**1}-p_{1*1}p_{*11}))=
    $$
    $$
        =(p_{111}p_{**1}-p_{1*1}p_{*11})+p_{**1}(p_{110}p_{**0}-p_{1*0}p_{*10})-p_{**1}(p_{111}p_{**1}-p_{1*1}p_{*11})=
    $$
    $$
        =(1-p_{**1})(p_{111}p_{**1}-p_{1*1}p_{*11})+p_{**1}(p_{110}p_{**0}-p_{1*0}p_{*10})=
    $$
    $$
        =p_{**0}(p_{111}p_{**1}-p_{1*1}p_{*11})+p_{**1}(p_{110}p_{**0}-p_{1*0}p_{*10})
    $$
    Также заметим, что:
    \begin{enumerate}
        \item
    $$
        p_{111}p_{**1}-p_{1*1}p_{*11} = p_{111}(p_{001}+p_{011}+p_{101}+p_{111})-
        (p_{101}+p_{111})(p_{011}+p_{111})=
    $$
    $$
        = p_{111}p_{001}+p_{111}p_{011}+p_{111}p_{101}+p_{111}p_{111} -
    $$
    $$
        - p_{101}p_{011}-p_{101}p_{111}-p_{111}p_{011}-p_{111}p_{111}=
    $$
    $$
        = p_{001}p_{111}-p_{011}p_{101}
    $$
    \item
    $$
        p_{110}p_{**0}-p_{1*0}p_{*10}=
        p_{110}(p_{000}+p_{010}+p_{100}+p_{110})-(p_{100}+p_{110})(p_{010}+p_{110})=
    $$
    $$
        =p_{110}p_{000}+p_{110}p_{010}+p_{110}p_{100}+p_{110}p_{110} -
    $$ $$
        -p_{100}p_{010}-p_{100}p_{110}-p_{110}p_{010}-p_{110}p_{110}=
    $$
    $$
        =p_{000}p_{110}-p_{010}p_{100}
    $$
    \end{enumerate}
    Таким образом:
    $$
    \sigma_{XY} \sigma_{ZZ} - \sigma_{XZ} \sigma_{YZ} = p_{**0}(p_{001}p_{111}-p_{011}p_{101}) + p_{**1} (p_{000}p_{110}-p_{010}p_{100})
    $$
\end{proof}
Вышеприведенное соотношение позволяет доказать следующую теорему.
\begin{theorem}\label{1.2}
    Пусть $X$ и $Y$ условно независимы при условии $Z$. Тогда $\rho^{XY \cdot Z}=0$.
\end{theorem}
\begin{proof}
    Пусть $X$ и $Y$ условно независимы при условии $Z$. Тогда по теореме \ref{thm1}:
    $p_{000}p_{110}=p_{010}p_{100}$ и 
    $p_{001}p_{111}=p_{011}p_{101}$.
    Используя вышеприведенные соотношения в числителе частного коэффициента корреляции Пирсона имеем:
    $$
        p_{**0}(p_{001}p_{111}-p_{011}p_{101}) + p_{**1} (p_{000}p_{110}-p_{010}p_{100})= 0
    $$
    Следовательно, $\rho^{XY \cdot Z}=0$.
\end{proof}
Таким образом, ноль в частном коэффициенте корреляции Пирсона является необходимым условием условной независимости.
Однако, не является достаточным условием, так как в обратную сторону теорема \ref{1.2} неверна. Легко построить контрпример при $p_{**0}=0$. Далее покажем контрпример при $p_{**0} \neq 0$.
\begin{example}
    Пусть $p_{000}=0.15$, $p_{001}=0.1$, $p_{010}=0.1$, $p_{011}=0.15$, $p_{100}=0.1$, $p_{101}=0.15$, $p_{110}=0.15$, $p_{111}=0.1$.
    Тогда $p_{**0}=0.5$, $p_{**1}=0.5$ и
    $M_{21} = p_{**1}(p_{000}p_{110}-p_{010}p_{100}) + p_{**0}(p_{001}p_{111}-p_{011}p_{101})= 0.5 \cdot (0.15 \cdot 0.15 - 0.1 \cdot 0.1) + 0.5 \cdot (0.1 \cdot 0.1 - 0.15 \cdot 0.15) = 0$.

    Однако, случайные величины $X$ и $Y$ условно зависимы при условии $Z$ поскольку:
    $$
        p_{000}p_{110}-p_{010}p_{100}=0.15 \cdot 0.15 - 0.1 \cdot 0.1 = 0.0125 \neq 0
    $$
    $$
        p_{001}p_{111}-p_{011}p_{101}=0.1 \cdot 0.1 - 0.15 \cdot 0.15 = -0.0125 \neq 0
    $$
\end{example}

Приведем альтернативную формулу, с помощью которой удобно вычислять частный коэффициент корреляции Пирсона.

\begin{lemma}\label{partial_formula2}
    $$
    \rho^{XY \cdot Z}=\dfrac{\rho_{XY}-\rho_{XZ}\rho_{YZ}}{\sqrt{1-\rho_{XZ}^2}\sqrt{1-\rho_{YZ}^2}}
    $$
    где $\rho_{XY}, \rho_{XZ}, \rho_{YZ}$ -- коэффициенты корреляции Пирсона
    между случайными величинами $X$ и $Y$, $X$ и $Z$, $Y$ и $Z$
    соответственно.
\end{lemma}
\begin{proof}
    $$
    \rho^{XY \cdot Z}=\dfrac{\sigma_{XY} \sigma_{ZZ} - \sigma_{XZ} \sigma_{YZ}}{\sqrt{\sigma_{XX}\sigma_{ZZ}-
    \sigma_{XZ}^2}\sqrt{\sigma_{YY}\sigma_{ZZ}-\sigma_{YZ}^2}}
    $$
    $$
    =\dfrac{\sigma_{ZZ}\sqrt{\sigma_{XX}\sigma_{YY}}
    \left(\dfrac{\sigma_{XY}}{\sqrt{\sigma_{XX}\sigma_{YY}}} 
    - \dfrac{\sigma_{XZ}}{\sqrt{\sigma_{XX}\sigma_{ZZ}}} \dfrac{\sigma_{YZ}}{\sqrt{\sigma_{YY}\sigma_{ZZ}}}\right)}
    {\sqrt{\sigma_{XX}\sigma_{ZZ}-
    \sigma_{XZ}^2}\sqrt{\sigma_{YY}\sigma_{ZZ}-\sigma_{YZ}^2}}=
    $$
    $$
    =\dfrac{\rho_{XY}-\rho_{XZ}\rho_{YZ}}{\sqrt{1-\dfrac{\sigma_{XZ}^2}{\sigma_{XX}\sigma_{ZZ}}}
    \sqrt{1-\dfrac{\sigma_{YZ}^2}{\sigma_{YY}\sigma_{ZZ}}}}
    =\dfrac{\rho_{XY}-\rho_{XZ}\rho_{YZ}}{\sqrt{1-\rho_{XZ}^2}\sqrt{1-\rho_{YZ}^2}}
    $$
\end{proof}
Классически для оценки частного коэффициента корреляции Пирсона используют выборочный частный коэффициент корреляции Пирсона:
$$r^{XY\cdot Z}=\dfrac{r_{XY}-r_{XZ}r_{YZ}}{\sqrt{1-r_{XY}^2}\sqrt{1-r_{YZ}^2}}$$
где $r_{XY}$, $r_{XZ}$, $r_{YZ}$ -- выборочные коэффициенты корреляции Пирсона
между случайными величинами $X$ и $Y$, $X$ и $Z$, $Y$ и $Z$
соответственно. 

Для нормального распределения известно \cite{Anderson2003}, что при истинности гипотезы $\rho^{XY \cdot Z}=0$ статистика
$$
T=\sqrt{n-3} \dfrac{r^{XY \cdot Z}}{\sqrt{1-(r^{XY \cdot Z})^2}}
$$
имеет распределение Стьюдента с $n-3$ степенями свободы.
Тогда тест уровня $\alpha$ проверки гипотезы $H: \rho^{XY\cdot Z}=0$ против альтернативы $K: \rho^{XY\cdot Z} \neq 0$ имеет вид:
$$
\varphi^{\text{Partial}}(t) = \begin{cases}
    1, \; t<C_1 \text{ или } t>C_2 \\ 
    0, \; C_1 \leq t \leq C_2
\end{cases}
$$
где константы $C_1$ и $C_2$, удовлетворяют уравнениям $P(T<C_1)~=~\alpha/2$ и $P(T>C_2)=1-\alpha/2$.

В настоящей работе с помощью численных экспериментов
будет проверено контролирует ли тест 
$\varphi^{\text{Partial}}$ вероятность ошибки первого рода
в трехмерном распределении Бернулли.
% \begin{lemma}
%     Пусть $\Sigma$ -- ковариационная матрица с элементами
%     $$\Sigma =
%     \begin{pmatrix}
%         \sigma_{XX} & \sigma_{XY} & \sigma_{XZ} \\
%         \sigma_{YX} & \sigma_{YY} & \sigma_{YZ} \\
%         \sigma_{ZX} & \sigma_{ZY} & \sigma_{ZZ}
%     \end{pmatrix}
%     $$
%     а $\Sigma^{-1}$ обратная ковариационная матрица с элементами
%     $$\Sigma^{-1} =
%     \begin{pmatrix}
%         \sigma^{XX} & \sigma^{XY} & \sigma^{XZ} \\
%         \sigma^{YX} & \sigma^{YY} & \sigma^{YZ} \\
%         \sigma^{ZX} & \sigma^{ZY} & \sigma^{ZZ}
%     \end{pmatrix}
%     $$
%     Тогда для частного коэффициента корреляции справедливо:
%     $$
%     \rho^{XY \cdot Z}=-\dfrac{\sigma^{XY}}{\sqrt{\sigma^{XX}\sigma^{YY}}}
%     $$
% \end{lemma}
% \begin{proof}
%     Воспользуемся следующими соотношениями для элементов обратной матрицы:
%     $$
%     \sigma^{XY}=\dfrac{-1}{det(\Sigma)}\begin{vmatrix}
%     \sigma_{XY} & \sigma_{XZ}\\
%     \sigma_{YZ} & \sigma_{ZZ}
%     \end{vmatrix}=\dfrac{-(\sigma_{XY}\sigma_{ZZ}-\sigma_{XZ}\sigma_{YZ})}{det(\Sigma)}
%     $$

%     $$
%     \sigma^{XX}=\dfrac{1}{det(\Sigma)}\begin{vmatrix}
%     \sigma_{YY} & \sigma_{YZ}\\
%     \sigma_{YZ} & \sigma_{ZZ}
%     \end{vmatrix}
%     = \dfrac{\sigma_{YY}\sigma_{ZZ}-\sigma_{YZ}^2}{det(\Sigma)}
%     $$

%     $$
%     \sigma^{YY}=\dfrac{1}{det(\Sigma)}\begin{vmatrix}
%     \sigma_{XX} & \sigma_{XZ}\\
%     \sigma_{XZ} & \sigma_{ZZ}
%     \end{vmatrix}
%     = \dfrac{\sigma_{XX}\sigma_{ZZ}-\sigma_{XZ}^2}{det(\Sigma)}
%     $$
%     Тогда:
%     $$
%     -\dfrac{\sigma^{XY}}{\sqrt{\sigma^{XX}\sigma^{YY}}}=-\dfrac{
%         \dfrac{-(\sigma_{XY}\sigma_{ZZ}-\sigma_{XZ}\sigma_{YZ})}{det(\Sigma)}
%     }{
%         \sqrt{\dfrac{\sigma_{XX}\sigma_{ZZ}-\sigma_{XZ}^2}{det(\Sigma)}}
%         \sqrt{\dfrac{\sigma_{YY}\sigma_{ZZ}-\sigma_{YZ}^2}{det(\Sigma)}}
%     }=
%     $$
%     $$
%     = \dfrac{\sigma_{XY}\sigma_{ZZ}-\sigma_{XZ}\sigma_{YZ}}{
%         \sqrt{\sigma_{XX}\sigma_{ZZ}-\sigma_{XZ}^2}
%         \sqrt{\sigma_{YY}\sigma_{ZZ}-\sigma_{YZ}^2}
%     }=\rho^{XY \cdot Z}
%     $$
% \end{proof}